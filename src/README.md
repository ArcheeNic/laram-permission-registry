# Модуль управления реестром доступов (PermissionRegistry)

## Назначение

Модуль предназначен для централизованного управления доступами пользователей к различным сервисам и ресурсам. Он обеспечивает гибкий механизм определения прав доступа через систему доступов, полей, групп и должностей, а также предоставляет события для интеграции с другими системами.

## Архитектура

Модуль построен на принципах Domain-Driven Design и соответствует модульной архитектуре приложения. Основные компоненты:

- **Модели** - представляют сущности доменной области
- **Действия (Actions)** - инкапсулируют бизнес-логику
- **События (Events)** - обеспечивают слабую связность компонентов
- **Слушатели (Listeners)** - реагируют на события
- **Контроллеры** - обрабатывают HTTP-запросы
- **Livewire-компоненты** - управляют интерактивным пользовательским интерфейсом

## Модель данных

### Основные сущности

1. **Доступ (Permission)**
    - Сервис (service)
    - Название (name)
    - Описание (description)
    - Теги (tags)

2. **Поле доступа (PermissionField)**
    - Название (name)
    - Значение по умолчанию (default_value)
    - Связь многие-ко-многим с Доступами

3. **Группа доступов (PermissionGroup)**
    - Название (name)
    - Описание (description)
    - Связь многие-ко-многим с Доступами

4. **Должность (Position)**
    - Название (name)
    - Описание (description)
    - Наследование (доступы, группы доступов, доступы дочерних должностей)

5. **Пользователь (VirtualUser)**
    - Имя (first_name)
    - Фамилия (last_name)
    - Контакты (contacts - JSON)
    - Примечание (notes)

6. **Выданный доступ (GrantedPermission)**
    - Связь с пользователем
    - Связь с доступом
    - Статус (enabled)
    - Дополнительная информация (meta - JSON)
    - Дата выдачи (granted_at)
    - Дата истечения (expires_at)
    - Включает значения полей доступа

7. **Значение поля выданного доступа (GrantedPermissionFieldValue)**
    - Связь с выданным доступом
    - Связь с полем доступа
    - Значение поля (value)

7. **Группа пользователя (UserGroup)**
    - Связь с пользователем
    - Связь с группой доступов

8. **Должность пользователя (UserPosition)**
    - Связь с пользователем
    - Связь с должностью

### Диаграмма отношений

```
Position <---> PermissionGroup
    |               |
    v               v
  Permission <--> PermissionField
    ^               ^
    |               |
    v               v
GrantedPermission <--> GrantedPermissionFieldValue
    ^
    |
    v
  User <---> UserGroup
    ^
    |
    v
  UserPosition
```

## События жизненного цикла

### События доступа
- `BeforePermissionGranted` - перед выдачей доступа
- `AfterPermissionGranted` - после выдачи доступа
- `BeforePermissionRevoked` - перед отзывом доступа
- `AfterPermissionRevoked` - после отзыва доступа

### События пользователя
- `UserCreated` - при создании пользователя
- `UserDeleted` - при удалении пользователя
- `UserPositionChanged` - при изменении должности пользователя
- `UserGroupChanged` - при изменении группы пользователя

## Интеграция с другими модулями

Для взаимодействия с другими модулями используются глобальные слушатели.
Внутри модуля события работают локально, а для межмодульного взаимодействия
используется паттерн событие-мост, где глобальный слушатель транслирует
события между модулями.

```php
// Пример глобального слушателя для перехвата события
namespace App\Listeners;

use App\Modules\PermissionRegistry\Events\PermissionGranted;
use App\Modules\OtherModule\Events\AccessChanged;
use Illuminate\Events\Dispatcher;
use Illuminate\Support\Facades\Event;

class PermissionRegistryBridge
{
    public function handle(PermissionGranted $event): void
    {
        Event::dispatch(new AccessChanged($event->userId, $event->permissionName));
    }

    public function subscribe(Dispatcher $events): array
    {
        return [
            PermissionGranted::class => 'handle',
        ];
    }
}
```

## Определение и выдача доступов

Модуль работает по следующим принципам при управлении доступами:

1. **Определение необходимых доступов** - на основе должностей и групп пользователя определяется, какие доступы должны быть у пользователя
2. **Создание записей только при фактической выдаче** - запись о выданном доступе создается только при фактической выдаче доступа, а не автоматически при назначении должности или добавлении в группу
3. **Создание значений полей доступа** - при выдаче доступа автоматически создаются записи для всех полей доступа, указанных в справочнике, с их значениями по умолчанию или указанными значениями
4. **Обработка изменений** - при изменении доступов в группе или должности модуль определяет, каким пользователям нужно выдать новые доступы или отозвать существующие
4. **Приоритет индивидуальных доступов** - индивидуально выданные доступы имеют приоритет над доступами, определенными должностями и группами

## Расширяемость

Модуль спроектирован для легкого расширения:

- **Добавление новых типов доступов** - путем регистрации новых сервисов
- **Расширение метаданных** - через JSON-поля для хранения произвольных данных
- **Интеграция с внешними системами** - через события жизненного цикла

## Рекомендации по использованию

### Настройка иерархии должностей
- Определите базовые должности с минимальным набором доступов
- Используйте наследование для создания должностей с расширенными правами
- Группируйте смежные доступы для удобного управления

### Аудит доступов
- Все операции выдачи и отзыва прав фиксируются в системе
- Используйте метаданные для хранения информации о причинах изменения доступов
- Отслеживайте историю изменений доступов для каждого пользователя

### Проверка доступов
```php
// Пример проверки доступа
$permissionChecker = app(PermissionChecker::class);
if ($permissionChecker->hasPermission($userId, 'service_name', 'permission_name')) {
    // Пользователь имеет доступ
}
```
